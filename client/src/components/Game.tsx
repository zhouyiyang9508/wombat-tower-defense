import { useState, useEffect } from 'react';
import { Socket } from 'socket.io-client';
import { GameBoard } from './GameBoard';
import { BuffSelect } from './BuffSelect';
import { BUFFS } from '../types/buffs';
import './Game.css';

interface Player {
  id: string;
  name: string;
  avatar: string;
}

interface GameState {
  gold: number;
  baseHP: number;
  maxBaseHP: number;
  wave: number;
  totalWaves: number;
  stage: number;
  totalStages: number;
  units: any[];
  enemies: any[];
  buffs: any[];
  status: 'waiting' | 'playing' | 'waveEnd' | 'stageEnd' | 'victory' | 'defeat';
  difficulty: string;
  goldMultiplier: number;
  costMultiplier: number;
  hpMultiplier: number;
}

interface GameProps {
  socket: Socket;
  room: any;
  myPlayerId: string;
}

const UNIT_CONFIG = {
  worker: { name: 'ğŸ‘· å†œæ°‘', cost: 50 },
  archer: { name: 'ğŸ¹ å¼“ç®­æ‰‹', cost: 100 },
  cannon: { name: 'ğŸ’£ ç‚®å¡”', cost: 200 }
};

export function Game({ socket, room, myPlayerId }: GameProps) {
  const [gameState, setGameState] = useState<GameState | null>(null);
  const [selectedUnit, setSelectedUnit] = useState<string | null>(null);
  const [pendingUnit, setPendingUnit] = useState<{ row: number; col: number; type: string } | null>(null);
  const [showBuffSelect, setShowBuffSelect] = useState(false);
  
  // åˆå§‹åŒ–5x15ç½‘æ ¼
  const [cells, setCells] = useState(() => {
    const initialCells = [];
    for (let row = 0; row < 5; row++) {
      const rowCells = [];
      for (let col = 0; col < 15; col++) {
        let type: 'empty' | 'base' | 'spawn' = 'empty';
        if (col === 0 && row === 2) type = 'base';
        if (col === 14) type = 'spawn';
        rowCells.push({ row, col, type, unit: null });
      }
      initialCells.push(rowCells);
    }
    return initialCells;
  });

  // ç›‘å¬æœåŠ¡å™¨çš„æ¸¸æˆçŠ¶æ€æ›´æ–°
  useEffect(() => {
    const handleGameStateUpdate = (newState: GameState) => {
      console.log('Game state updated:', newState);
      setGameState(newState);
      
      // æ›´æ–°æ ¼å­çŠ¶æ€ï¼ˆæ˜¾ç¤ºå•ä½ï¼‰
      const newCells = cells.map(row => 
        row.map(cell => ({
          ...cell,
          unit: newState.units.find(u => u.row === cell.row && u.col === cell.col) || null
        }))
      );
      setCells(newCells);
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºBuffé€‰æ‹©
      if (newState.status === 'stageEnd') {
        setShowBuffSelect(true);
      }
    };

    socket.on('game-state-update', handleGameStateUpdate);

    return () => {
      socket.off('game-state-update', handleGameStateUpdate);
    };
  }, [socket, cells]);

  if (!gameState) {
    return (
      <div className="game-loading">
        <h2>â³ æ¸¸æˆåŠ è½½ä¸­...</h2>
        <p>ç­‰å¾…æœåŠ¡å™¨åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€</p>
      </div>
    );
  }

  const handleCellClick = (row: number, col: number) => {
    if (!selectedUnit) return;
    
    // æ£€æŸ¥é‡‘å¸
    const cost = UNIT_CONFIG[selectedUnit as keyof typeof UNIT_CONFIG].cost * gameState.costMultiplier;
    if (gameState.gold < cost) {
      alert('é‡‘å¸ä¸è¶³ï¼');
      return;
    }
    
    // æ£€æŸ¥æ ¼å­
    if (cells[row][col].type !== 'empty' || cells[row][col].unit) {
      alert('è¯¥æ ¼å­ä¸å¯ç”¨ï¼');
      return;
    }
    
    // æ˜¾ç¤ºé¢„è´­ç¡®è®¤
    setPendingUnit({ row, col, type: selectedUnit });
  };

  const confirmDeploy = () => {
    if (!pendingUnit) return;
    
    const { row, col, type } = pendingUnit;
    
    // å‘é€åˆ°æœåŠ¡å™¨
    socket.emit('deploy-unit', {
      roomId: room.id,
      unit: { type, row, col, id: `unit-${Date.now()}` }
    });
    
    setPendingUnit(null);
    setSelectedUnit(null);
  };

  const cancelDeploy = () => {
    setPendingUnit(null);
  };

  const handleSpawnWave = () => {
    socket.emit('spawn-wave', room.id);
  };

  const handleNextWave = () => {
    socket.emit('next-wave', room.id);
  };

  const handleBuffSelect = (buff: any) => {
    socket.emit('select-buff', { roomId: room.id, buffId: buff.id });
    setShowBuffSelect(false);
  };

  const units = [
    { type: 'worker', ...UNIT_CONFIG.worker },
    { type: 'archer', ...UNIT_CONFIG.archer },
    { type: 'cannon', ...UNIT_CONFIG.cannon }
  ];

  return (
    <div className="game">
      {/* é¡¶éƒ¨çŠ¶æ€æ  */}
      <div className="game-header">
        <div className="game-stats">
          <div className="stat">
            <span className="stat-icon">ğŸ’°</span>
            <span className="stat-value">{Math.floor(gameState.gold)}</span>
            {gameState.goldMultiplier > 1 && (
              <span className="stat-multiplier">Ã—{gameState.goldMultiplier.toFixed(1)}</span>
            )}
          </div>
          <div className="stat">
            <span className="stat-icon">â¤ï¸</span>
            <span className="stat-value">{Math.floor(gameState.baseHP)}/{gameState.maxBaseHP}</span>
          </div>
          <div className="stat">
            <span className="stat-icon">ğŸ°</span>
            <span className="stat-value">å…³å¡ {gameState.stage}/{gameState.totalStages}</span>
          </div>
          <div className="stat">
            <span className="stat-icon">ğŸŒŠ</span>
            <span className="stat-value">æ³¢æ¬¡ {gameState.wave}/{gameState.totalWaves}</span>
          </div>
          <div className="stat">
            <span className="stat-icon">ğŸ‘¾</span>
            <span className="stat-value">{gameState.enemies.length} æ•Œäºº</span>
          </div>
        </div>
        
        {/* Buffåˆ—è¡¨ */}
        {gameState.buffs.length > 0 && (
          <div className="active-buffs">
            {gameState.buffs.map((buff, index) => {
              const buffData = BUFFS.find(b => b.id === buff.id);
              return buffData ? (
                <div key={index} className="active-buff" title={buffData.description}>
                  <span className="buff-emoji">{buffData.emoji}</span>
                </div>
              ) : null;
            })}
          </div>
        )}
        
        <div className="players-mini">
          {room.players.map((player: Player) => (
            <div key={player.id} className="player-mini">
              <div className="player-mini-avatar">
                {player.avatar?.startsWith('data:') ? (
                  <img src={player.avatar} alt={player.name} />
                ) : (
                  <span>{player.avatar}</span>
                )}
              </div>
              <span className="player-mini-name">{player.name}</span>
            </div>
          ))}
        </div>

        {gameState.status === 'waiting' && (
          <button onClick={handleSpawnWave} className="btn-wave">
            å¼€å§‹æ³¢æ¬¡ {gameState.wave}
          </button>
        )}

        {gameState.status === 'waveEnd' && (
          <button onClick={handleNextWave} className="btn-wave">
            ç»§ç»­ä¸‹ä¸€æ³¢
          </button>
        )}
      </div>

      {/* æ¸¸æˆåŒºåŸŸ */}
      <div className="game-area">
        <GameBoard cells={cells} onCellClick={handleCellClick} />
        
        {/* æ•Œäººæ˜¾ç¤º */}
        <div className="enemies-layer">
          {gameState.enemies.map(enemy => (
            <div
              key={enemy.id}
              className="enemy"
              style={{
                top: `${enemy.row * 64 + 20}px`,
                left: `${enemy.progress * 960 + 60}px`
              }}
            >
              {enemy.type === 'zombie' && 'ğŸ§Ÿ'}
              {enemy.type === 'tank' && 'ğŸ›¡ï¸'}
              {enemy.type === 'boss' && 'ğŸ‘¹'}
              <div className="enemy-hp">
                <div className="enemy-hp-bar" style={{ width: `${(enemy.hp / enemy.maxHP) * 100}%` }} />
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* åº•éƒ¨å•ä½é€‰æ‹©æ  */}
      <div className="unit-bar">
        {units.map(unit => {
          const cost = Math.floor(unit.cost * gameState.costMultiplier);
          return (
            <button
              key={unit.type}
              className={`unit-button ${selectedUnit === unit.type ? 'selected' : ''} ${gameState.gold < cost ? 'disabled' : ''}`}
              onClick={() => setSelectedUnit(unit.type)}
              disabled={gameState.gold < cost}
            >
              <div className="unit-button-content">
                <span className="unit-icon">{unit.name}</span>
                <span className="unit-cost">ğŸ’° {cost}</span>
              </div>
            </button>
          );
        })}
      </div>

      {/* é¢„è´­ç¡®è®¤å¼¹çª— */}
      {pendingUnit && (
        <div className="modal-overlay" onClick={cancelDeploy}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <h3>ç¡®è®¤éƒ¨ç½²</h3>
            <p>
              {room.players.find((p: Player) => p.id === myPlayerId)?.name} æƒ³åœ¨ ({pendingUnit.row}, {pendingUnit.col}) éƒ¨ç½²
              <strong> {UNIT_CONFIG[pendingUnit.type as keyof typeof UNIT_CONFIG].name}</strong>
            </p>
            <p className="modal-cost">
              èŠ±è´¹: <strong>ğŸ’° {Math.floor(UNIT_CONFIG[pendingUnit.type as keyof typeof UNIT_CONFIG].cost * gameState.costMultiplier)}</strong>
            </p>
            <div className="modal-buttons">
              <button onClick={cancelDeploy} className="btn-secondary">
                å–æ¶ˆ
              </button>
              <button onClick={confirmDeploy} className="btn-primary">
                âœ… ç¡®è®¤
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Buffé€‰æ‹© */}
      {showBuffSelect && (
        <BuffSelect buffs={BUFFS.slice(0, 3)} onSelect={handleBuffSelect} />
      )}

      {/* æ³¢æ¬¡ç»“æŸæç¤º */}
      {gameState.status === 'waveEnd' && (
        <div className="wave-end-banner">
          <div className="wave-end-content">
            <h3>âœ… æ³¢æ¬¡ {gameState.wave - 1} å®Œæˆï¼</h3>
            <p>å‡†å¤‡å¥½è¿æ¥ä¸‹ä¸€æ³¢æ•Œäºº</p>
          </div>
        </div>
      )}

      {/* æ¸¸æˆç»“æŸ */}
      {gameState.status === 'victory' && (
        <div className="modal-overlay">
          <div className="modal victory-modal">
            <div className="victory-animation">ğŸ‰</div>
            <h2>èƒœåˆ©ï¼</h2>
            <p className="victory-message">ä½ ä»¬æˆåŠŸå®ˆä½äº†åŸºåœ°ï¼</p>
            <div className="victory-stats">
              <div className="stat-row">
                <span>å®Œæˆå…³å¡</span>
                <strong>{gameState.stage}/{gameState.totalStages}</strong>
              </div>
              <div className="stat-row">
                <span>éš¾åº¦</span>
                <strong>{gameState.difficulty.toUpperCase()}</strong>
              </div>
              <div className="stat-row">
                <span>å‰©ä½™è¡€é‡</span>
                <strong>{Math.floor(gameState.baseHP)}</strong>
              </div>
              <div className="stat-row">
                <span>è·å¾—Buff</span>
                <strong>{gameState.buffs.length}ä¸ª</strong>
              </div>
            </div>
          </div>
        </div>
      )}

      {gameState.status === 'defeat' && (
        <div className="modal-overlay">
          <div className="modal defeat-modal">
            <div className="defeat-animation">ğŸ’€</div>
            <h2>å¤±è´¥</h2>
            <p className="defeat-message">åŸºåœ°è¢«æ‘§æ¯äº†...</p>
            <div className="defeat-stats">
              <div className="stat-row">
                <span>å­˜æ´»å…³å¡</span>
                <strong>{gameState.stage}</strong>
              </div>
              <div className="stat-row">
                <span>æ³¢æ¬¡</span>
                <strong>{gameState.wave}/{gameState.totalWaves}</strong>
              </div>
              <div className="stat-row">
                <span>éš¾åº¦</span>
                <strong>{gameState.difficulty.toUpperCase()}</strong>
              </div>
            </div>
            <button onClick={() => window.location.reload()} className="btn-retry">
              é‡æ–°å¼€å§‹
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

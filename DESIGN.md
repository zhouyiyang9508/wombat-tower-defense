# Wombat Tower Defense - 设计文档

## 🎮 游戏概述

一款双人合作的塔防 Rogue-like 游戏，灵感来自植物大战僵尸，但加入了更硬核的难度、双人协作机制和 Rogue-like 的随机性与策略深度。

**核心特色：**
- 🤝 双人实时合作（WebSocket 同步）
- 🎭 角色自定义（头像上传 + 简易捏脸）
- 🎲 Rogue-like 闯关系统（buff选择、组合build、失败重开）
- 💰 资源生产系统（农民生产货币，不用手动采集）
- 🔥 高难度挑战（杂交版PvZ风格 + Boss关卡）

---

## 🎯 核心玩法设计

### 1. 双人合作机制

**共享资源池：**
- 两位玩家共享金币资源
- 共享防线（同一张地图）
- 可以互相配合布置防御单位

**角色定位：**
- 玩家可选择偏向"生产"或"战斗"的buff
- 一人专注经济发展，一人专注防御布局
- 或者双人平衡发展

**同步机制：**
- 实时同步游戏状态（单位位置、血量、金币、buff）
- 一方掉线后可以重连（保存游戏状态）

---

### 2. 资源生产系统（替代采阳光）

**农民单位（Worker）：**
- 可在后排部署"农民"单位
- 每个农民每秒产生固定金币（如 5金币/秒）
- 农民自身有血量，可被怪物攻击
- 升级农民可提高产出效率

**金币用途：**
- 购买防御塔/战斗单位
- 部署更多农民
- 升级单位
- 关卡间的buff购买

**策略选择：**
- 早期多造农民 → 后期经济碾压
- 早期多造防御 → 稳定但后劲不足
- 平衡发展 → 考验操作和配合

---

### 3. Rogue-like 闯关系统

**关卡结构：**
```
普通关1 → 普通关2 → 普通关3 → Boss关1
  ↓
普通关4 → 普通关5 → 普通关6 → Boss关2
  ↓
... (难度递增)
  ↓
最终Boss
```

**每关后的Buff选择（3选1）：**

| 类别 | Buff示例 | 效果 |
|------|---------|------|
| 经济类 | 黄金时代 | 农民产出 +50% |
| | 节俭专家 | 所有单位成本 -20% |
| 防御类 | 铜墙铁壁 | 所有防御塔血量 +30% |
| | 狂热射手 | 射速 +25% |
| 特殊类 | 吸血鬼 | 击杀敌人恢复基地1%血量 |
| | 时间扭曲 | 每波开始获得5秒怪物减速 |
| 组合类 | 雷电链 | 攻击有15%几率链式闪电（需"狂热射手"） |
| | 黄金农场 | 农民死亡时爆炸并产生50金币（需"黄金时代"） |

**组合Build示例：**
- **速攻流**：节俭专家 + 狂热射手 + 雷电链 → 低成本快速布防
- **经济流**：黄金时代 + 黄金农场 + 铜墙铁壁 → 后期无敌
- **生存流**：吸血鬼 + 时间扭曲 + 铜墙铁壁 → 超高容错

**失败惩罚：**
- 基地血量归零 → 游戏结束，从第1关重开
- Buff重置，需要重新选择
- 保留"解锁成就"（如首次击败Boss3解锁新单位）

---

### 4. 防御单位设计

**基础单位：**

| 单位 | 成本 | 攻击 | 特性 |
|------|------|------|------|
| 农民 | 50 | 无 | 5金币/秒 |
| 弓箭手 | 100 | 15 | 基础远程 |
| 炮塔 | 200 | 50 | 范围AOE |
| 冰冻塔 | 150 | 10 | 减速50% |
| 电磁塔 | 250 | 0 | 眩晕2秒 |

**升级系统：**
- 每个单位可升级3次（Lv1 → Lv2 → Lv3 → Lv4）
- 升级成本递增：100 → 200 → 400
- 提升攻击/血量/特效

**解锁机制：**
- 初始只有3种单位
- 击败Boss解锁新单位（如Boss1解锁"激光塔"）

---

### 5. 敌人设计

**普通怪物：**

| 类型 | 血量 | 速度 | 特性 |
|------|------|------|------|
| 小僵尸 | 50 | 快 | 基础单位 |
| 坦克僵尸 | 200 | 慢 | 高血量 |
| 飞行僵尸 | 80 | 快 | 免疫地面攻击 |
| 自爆僵尸 | 30 | 很快 | 接触基地爆炸（伤害50） |

**Boss设计：**

| Boss | 阶段 | 特殊机制 |
|------|------|---------|
| Boss1: 巨型僵尸 | 每25%血量召唤小怪 | 血量1000 |
| Boss2: 僵尸王 | 全场减速光环 | 血量2000，周围怪物+50%移速 |
| Boss3: 僵尸博士 | 切换形态（远程/近战） | 血量3000，每30秒切换 |

**难度曲线：**
- 第1关：10波，简单怪物
- 第3关（Boss前）：15波，混合怪物
- Boss关：1个Boss + 持续刷小怪
- 后期关卡：多路进攻、飞行单位增多

---

### 6. 地图设计

**布局：**
```
[基地] ← [防御区5格] ← [战场10格] ← [敌人出生点]
```

**多路径系统（中后期）：**
```
     路径1
    ↙
[基地]  路径2（主路）
    ↘
     路径3
```

**格子系统：**
- 5行 × 15列
- 后方5列：只能放农民/后勤单位
- 前方10列：战斗区域
- 每格只能放1个单位

---

### 7. 角色自定义

**头像上传：**
- 支持 JPG/PNG，最大2MB
- 裁剪成圆形头像（128x128px）
- 存储在服务器（或转Base64）

**简易捏脸：**
- 5种脸型（圆形、方形、椭圆、三角、梯形）
- 5种眼睛样式
- 5种嘴巴样式
- 5种发型
- 10种颜色（肤色、发色）
- 预览实时更新

**显示位置：**
- 游戏内左上角显示两位玩家头像
- 捏脸形象作为"指挥官"角色在基地旁

---

## 🛠️ 技术架构

### 前端技术栈

- **框架**：React 18 + TypeScript
- **游戏引擎**：PixiJS v8（2D渲染，性能优秀）
- **UI框架**：TailwindCSS + HeadlessUI
- **状态管理**：Zustand（轻量级）
- **实时通信**：Socket.IO Client
- **构建工具**：Vite

### 后端技术栈

- **服务器**：Node.js + Express
- **实时通信**：Socket.IO
- **数据存储**：
  - 游戏状态：内存（Redis可选）
  - 用户数据：SQLite（简单部署）
  - 头像文件：本地文件系统
- **部署**：Docker + PM2

### 数据结构设计

```typescript
// 游戏状态
interface GameState {
  roomId: string;
  players: [Player, Player];
  stage: number;          // 当前关卡
  wave: number;           // 当前波次
  gold: number;           // 共享金币
  baseHP: number;         // 基地血量
  buffs: Buff[];          // 已选择的buff
  units: Unit[];          // 地图上的单位
  enemies: Enemy[];       // 当前敌人
  status: 'waiting' | 'playing' | 'buffSelect' | 'gameOver';
}

// 玩家信息
interface Player {
  id: string;
  name: string;
  avatar: string;         // URL或Base64
  face: FaceConfig;       // 捏脸配置
  isReady: boolean;
}

// Buff系统
interface Buff {
  id: string;
  name: string;
  description: string;
  effect: (state: GameState) => void;
  combo?: string[];       // 需要的前置buff
}

// 单位系统
interface Unit {
  id: string;
  type: 'worker' | 'archer' | 'cannon' | 'ice' | 'electric';
  position: { row: number; col: number };
  level: 1 | 2 | 3 | 4;
  hp: number;
  maxHP: number;
  attack: number;
  attackSpeed: number;    // 秒
  range: number;          // 格子数
  lastAttackTime: number;
}

// 敌人系统
interface Enemy {
  id: string;
  type: 'normal' | 'tank' | 'flying' | 'bomber';
  path: number;           // 路径编号
  progress: number;       // 进度(0-1)
  hp: number;
  maxHP: number;
  speed: number;
  effects: Effect[];      // 减速、眩晕等
}
```

---

## 📋 开发计划

### 阶段划分（每阶段3小时）

#### Phase 1: 项目框架搭建
- [ ] 创建项目结构（前后端分离）
- [ ] 配置 Vite + React + TypeScript
- [ ] 搭建 Express + Socket.IO 服务器
- [ ] 实现基础的房间创建/加入逻辑
- [ ] 测试双人连接

**产出**：可以创建房间、两个客户端连接并看到彼此

---

#### Phase 2: 捏脸系统
- [ ] 设计捏脸UI界面
- [ ] 实现5种脸型、眼睛、嘴巴、发型的SVG组件
- [ ] 颜色选择器
- [ ] 实时预览
- [ ] 头像上传功能（裁剪+压缩）
- [ ] 保存到服务器

**产出**：完整的角色自定义界面

---

#### Phase 3: 游戏核心 - 地图与格子系统
- [ ] 用PixiJS渲染5×15格子地图
- [ ] 实现格子高亮/选中逻辑
- [ ] 绘制基地、敌人出生点
- [ ] 相机控制（平移、缩放）
- [ ] 显示玩家头像在左上角

**产出**：可视化的游戏地图

---

#### Phase 4: 单位系统 - 基础防御单位
- [ ] 实现农民单位（部署+金币生产）
- [ ] 实现弓箭手、炮塔、冰冻塔
- [ ] 单位的攻击逻辑（寻找目标、射击动画）
- [ ] 单位升级系统
- [ ] 单位血条显示

**产出**：可以部署单位，单位能攻击（敌人暂用假数据）

---

#### Phase 5: 敌人系统 - 基础AI
- [ ] 实现4种基础敌人（小僵尸、坦克、飞行、自爆）
- [ ] 敌人沿路径移动（A*寻路或预设路径）
- [ ] 敌人受伤、死亡动画
- [ ] 敌人攻击基地逻辑
- [ ] 波次系统（定时刷怪）

**产出**：敌人会从右侧走向基地，单位能击杀敌人

---

#### Phase 6: 游戏循环 - 完整一局
- [ ] 实现金币系统（UI显示）
- [ ] 波次倒计时UI
- [ ] 基地血量UI
- [ ] 胜利/失败判定
- [ ] 重开游戏逻辑
- [ ] 暂停/加速功能

**产出**：可以完整玩一局游戏（1关）

---

#### Phase 7: Rogue-like - Buff系统
- [ ] 设计15个Buff（经济/防御/特殊各5个）
- [ ] Buff选择界面（3选1卡牌）
- [ ] Buff效果实现（修改GameState）
- [ ] Buff组合检测（解锁强力效果）
- [ ] Buff图标显示在游戏内

**产出**：通关后可选Buff，Buff生效

---

#### Phase 8: 关卡系统 - 多关卡与Boss
- [ ] 配置10个关卡数据（怪物波次、类型、数量）
- [ ] 实现3个Boss（特殊技能）
- [ ] Boss战专属UI（血条、技能提示）
- [ ] 关卡进度显示
- [ ] 难度曲线调整

**产出**：可以连续闯10关，遇到Boss战

---

#### Phase 9: 多路径系统
- [ ] 实现3条路径（不同行）
- [ ] 怪物随机选择路径
- [ ] 某些关卡强制多路进攻
- [ ] 单位攻击优先级（选最近的敌人）
- [ ] 路径可视化

**产出**：增加游戏复杂度和策略性

---

#### Phase 10: 双人同步优化
- [ ] 延迟补偿（预测+回滚）
- [ ] 断线重连（保存游戏状态）
- [ ] 玩家操作提示（对方在哪个格子操作）
- [ ] 聊天功能（快捷语音）
- [ ] 观战模式（朋友可观战）

**产出**：流畅的双人体验

---

#### Phase 11: 音效与视觉优化
- [ ] 背景音乐（3首，可切换）
- [ ] 音效（射击、爆炸、金币）
- [ ] 粒子效果（火花、血液）
- [ ] 单位/敌人动画优化
- [ ] UI动效（按钮hover、卡牌翻转）

**产出**：游戏体验大幅提升

---

#### Phase 12: 成就与解锁系统
- [ ] 10个成就（如"首次击败Boss"）
- [ ] 成就解锁新单位
- [ ] 成就UI展示
- [ ] 持久化存储（SQLite）
- [ ] 排行榜（最远关卡）

**产出**：增加可玩性

---

#### Phase 13: 部署与测试
- [ ] Docker镜像打包
- [ ] 配置Nginx反向代理
- [ ] HTTPS证书（Let's Encrypt）
- [ ] 性能测试（多房间并发）
- [ ] Bug修复

**产出**：可公开访问的游戏

---

## ✅ To-Do 清单（按优先级）

### 高优先级（核心玩法）
- [ ] Phase 1-6：基础游戏循环
- [ ] Phase 7-8：Rogue-like系统

### 中优先级（体验提升）
- [ ] Phase 2：角色自定义
- [ ] Phase 9：多路径
- [ ] Phase 10：同步优化

### 低优先级（锦上添花）
- [ ] Phase 11：音效视觉
- [ ] Phase 12：成就系统
- [ ] Phase 13：部署

---

## 🎨 UI/UX 设计要点

### 主界面
```
┌─────────────────────────────────┐
│  Wombat Tower Defense           │
│                                 │
│  [创建房间]  [加入房间]          │
│  [角色自定义]                    │
│  [成就]  [设置]                  │
└─────────────────────────────────┘
```

### 游戏界面
```
┌──────────────────────────────────────┐
│ 👤P1  👤P2   💰1250   ❤️100   关卡3-2 │
│ Buff: ⚡️🛡️💰                         │
├──────────────────────────────────────┤
│                                      │
│  [    游戏地图 15x5 格子    ]        │
│                                      │
├──────────────────────────────────────┤
│ 🏹50  🧱100  ❄️150  ⚡200  [暂停]    │
└──────────────────────────────────────┘
```

### Buff选择界面
```
┌──────────────────────────────────┐
│   选择一个Buff (3选1)             │
│                                  │
│  ┌────┐  ┌────┐  ┌────┐          │
│  │⚡️  │  │💰  │  │🛡️  │          │
│  │狂热│  │黄金│  │铜墙│          │
│  │射手│  │时代│  │铁壁│          │
│  └────┘  └────┘  └────┘          │
│                                  │
│     双方都准备后进入下一关         │
└──────────────────────────────────┘
```

---

## 📊 难度平衡参考

### 金币经济
- 初始金币：500
- 每波奖励：100 + (关卡数 × 20)
- 农民产出：5金币/秒
- 单位成本：50-300

### 基地血量
- 初始：100
- Boss关额外+50

### 敌人数量（每波）
- 第1关：10只
- 每关+5只
- Boss关：Boss + 持续刷小怪

---

## 🌐 联机方案

### 方案1：云服务器部署（推荐 ⭐）

**最稳定、最简单的方式**

**步骤：**
1. 租一台云服务器（阿里云/腾讯云/AWS）
   - 最低配置：1核2G内存，5M带宽
   - 预计月费：30-50元
2. 部署Node.js服务器
3. 配置域名（可选，方便记忆）
4. 你和女友都访问同一个网址即可

**优点：**
- ✅ 稳定，24小时在线
- ✅ 不需要公网IP
- ✅ 延迟低（选择离你们近的机房）
- ✅ 朋友也可以加入

**缺点：**
- ❌ 需要月付服务器费用

---

### 方案2：你的电脑做服务器 + 端口转发

**免费但需要配置**

**步骤：**
1. 在你的电脑上运行服务器
2. 路由器配置端口转发（开放18080端口）
3. 使用你的公网IP或动态域名（DDNS）
4. 女友通过 `http://你的公网IP:18080` 连接

**优点：**
- ✅ 完全免费
- ✅ 数据在自己手里

**缺点：**
- ❌ 需要你的电脑一直开着
- ❌ 需要有公网IP（部分地区运营商不提供）
- ❌ 需要配置路由器（稍微复杂）
- ❌ 网络不稳定时会掉线

---

### 方案3：内网穿透（中间方案）

**使用frp/ngrok等工具**

**步骤：**
1. 在你的电脑上运行服务器
2. 使用内网穿透工具（如 [frp](https://github.com/fatedier/frp)）
3. 获得一个公网地址（如 `http://xxx.frp.example.com`）
4. 女友通过这个地址连接

**优点：**
- ✅ 不需要公网IP
- ✅ 不需要配置路由器
- ✅ 免费（frp）或低成本（ngrok $5/月）

**缺点：**
- ❌ 需要你的电脑一直开着
- ❌ 依赖第三方服务
- ❌ 可能有延迟（数据经过中转）

---

### 方案4：局域网联机（同一WiFi）

**如果你们住在一起**

**步骤：**
1. 两台设备连同一个WiFi
2. 在你的电脑运行服务器
3. 女友通过局域网IP连接（如 `http://192.168.1.100:18080`）

**优点：**
- ✅ 完全免费
- ✅ 零延迟
- ✅ 不需要任何配置

**缺点：**
- ❌ 只能同一WiFi下玩（异地不可用）

---

### 推荐方案

**异地恋 → 方案1（云服务器）** ⭐
- 最稳定，体验最好
- 一个月一杯奶茶钱

**偶尔玩 → 方案3（内网穿透）**
- 免费或低成本
- 需要电脑开机

**住在一起 → 方案4（局域网）**
- 零成本，零延迟

---

### 技术实现细节

**服务器部署脚本（Docker方式）：**
```bash
# 1. 克隆项目
git clone https://github.com/zhouyiyang9508/wombat-tower-defense.git
cd wombat-tower-defense

# 2. 构建并运行
docker-compose up -d

# 3. 访问
# http://你的服务器IP:18080
```

**Nginx反向代理（推荐，支持HTTPS）：**
```nginx
server {
    listen 80;
    server_name game.yourdomain.com;

    location / {
        proxy_pass http://localhost:18080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

**Socket.IO连接配置：**
```typescript
// 客户端自动检测环境
const socket = io(
  process.env.NODE_ENV === 'production'
    ? 'https://game.yourdomain.com'  // 生产环境
    : 'http://localhost:18080'        // 开发环境
);
```

---

## 🚀 下一步行动

1. **你审核本文档**，提出修改意见
2. **发给小袋熊review**，获取技术建议
3. **我根据反馈调整**设计
4. **开始Phase 1开发**（3小时内完成）
5. **设置cronjob**，每3小时自动推进

每个阶段结束后我会输出：
- ✅ 已完成功能列表
- 🔧 可改进的点
- 📋 下一阶段计划

---

**预计总开发时间：13阶段 × 3小时 = 39小时（约5天，按每天8小时计算）**

🐻 准备好开始了！等待你和小袋熊的反馈～
